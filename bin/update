#!/usr/bin/env bash
# bin/reflash
LIB_PATH="/Users/randy/Developer/Arduino/Matrix Portal M4/Circuit Python/Firmware"

if [ `dir /Volumes/|grep MATRIXBOOT|wc -l` == 0 ]; then
  echo -n "Double-click Reset button..."
fi
# echo "Press Enter when ready:"
# read

while [ `dir /Volumes/|grep MATRIXBOOT|wc -l` == 0 ]; do
  echo -n "."
  sleep 1
done
echo
echo -n "Erasing filesystem..."
cp "${LIB_PATH}/Matrix_Portal_M4_Erase_Filesystem.uf2" /Volumes/MATRIXBOOT

sleep 1
while [ `dir /Volumes/|grep MATRIXBOOT|wc -l` == 1 ]; do
  echo -n "."
  sleep 1
done
echo "Done!"
echo -n "Double-click Reset button..."

while [ `dir /Volumes/|grep MATRIXBOOT|wc -l` == 0 ]; do
  echo -n "."
  sleep 1
done
echo "Done!"
echo -n "Copying firmware..."

# cp "${LIB_PATH}/adafruit-circuitpython-matrixportal_m4-en_US-8.2.5.uf2" /Volumes/MATRIXBOOT/
# Sometimes fails with "cp: target '/Volumes/MATRIXBOOT/': Permission denied"
cp "${LIB_PATH}/adafruit-circuitpython-matrixportal_m4-en_US-10.0.3.uf2" /Volumes/MATRIXBOOT/
echo "Done!"

echo -n "Restarting..."
while [ `dir /Volumes/|grep CIRCUITPY|wc -l` == 0 ]; do
  echo -n "."
  sleep 1
done
echo "Done!"

# bin/build
SRC_PATH="/Users/randy/Developer/Arduino/Matrix Portal M4/Circuit Python/Moon Clock/src"
# LIB_PATH="/Users/randy/Developer/Arduino/Matrix Portal M4/Circuit Python/Libraries/adafruit-circuitpython-bundle-8.x-mpy-20230704/lib"
LIB_PATH="/Users/randy/Developer/Arduino/Matrix Portal M4/Circuit Python/Libraries/adafruit-circuitpython-bundle-10.x-mpy-20251114/lib"

echo -n "Copying files..."
mkdir -p build/lib
for lib in \
  adafruit_bitmap_font \
  adafruit_bus_device \
  adafruit_display_text \
  adafruit_esp32spi \
  adafruit_fakerequests.mpy \
  adafruit_io \
  adafruit_lis3dh.mpy \
  adafruit_matrixportal \
  adafruit_minimqtt \
  adafruit_portalbase \
  adafruit_requests.mpy \
  adafruit_ticks.mpy \
  neopixel.mpy
do
  echo -n "."
  if [ ! -r "${LIB_PATH}/${lib}" ]; then
    echo "ERROR: Unable to copy: ${LIB_PATH}/${lib}"
    exit 1
  fi
  cp -pr "${LIB_PATH}/${lib}" build/lib
done

for file in \
  boot.py \
  code.py \
  color.py \
  fonts \
  moon \
  secrets.py \
  sleeping.bmp \
  splash-landscape.bmp \
  splash-portrait.bmp
do
  echo -n "."
  cp -pr "${SRC_PATH}/${file}" build
done

# bin/deploy
BUILD_PATH="/Users/randy/Developer/Arduino/Matrix Portal M4/Circuit Python/Moon Clock/build"

rsync -aq "${BUILD_PATH}/" /Volumes/CIRCUITPY
echo "Done!"
